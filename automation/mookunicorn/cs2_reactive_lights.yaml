blueprint:
  name: CS2 Lampe R√©active
  description: Contr√¥le une lampe RGB en fonction des √©v√©nements du jeu CS2 via CS2MQTT
  domain: automation
  input:
    light_entity:
      name: üí° Lampe √† contr√¥ler
      description: La lampe RGB qui r√©agira aux √©v√©nements CS2
      selector:
        entity:
          domain: light
    
    # ===== CONFIGURATION √âQUIPES =====
    team_section:
      name: "‚öîÔ∏è Configuration des √©quipes"
      description: Param√®tres pour l'affichage des couleurs d'√©quipe
      icon: mdi:sword-cross
      collapsed: true
      input:
        enable_team_color:
          name: "Activer les couleurs d'√©quipe"
          description: Active l'affichage de la couleur d'√©quipe pendant la manche
          default: true
          selector:
            boolean:
        
        current_team:
          name: "Sensor √©quipe actuelle"
          description: Sensor indiquant l'√©quipe actuelle (T ou CT)
          selector:
            entity:
              domain: sensor
        
        round_phase:
          name: "Sensor phase de round"
          description: Sensor indiquant la phase du round (Over/Live/Freezetime)
          selector:
            entity:
              domain: sensor
        
        color_t:
          name: "Couleur √©quipe T"
          description: Couleur pour l'√©quipe Terrorist
          default: [255, 180, 0]
          selector:
            color_rgb:
        
        color_ct:
          name: "Couleur √©quipe CT"
          description: Couleur pour l'√©quipe Counter-Terrorist
          default: [0, 100, 255]
          selector:
            color_rgb:
    
    # ===== FLASH =====
    flash_section:
      name: "‚ö° Configuration Flash"
      description: Param√®tres pour l'effet de flash blanc
      icon: mdi:flash
      collapsed: true
      input:
        enable_flash:
          name: "Activer l'effet Flash"
          description: Active l'effet blanc quand le joueur est flash√©
          default: true
          selector:
            boolean:
        
        flashed_sensor:
          name: "Sensor Flash"
          description: Sensor indiquant si le joueur est flash√© (valeurs "True" ou "False" en texte)
          selector:
            entity:
              domain: sensor
    
    # ===== SMOKE =====
    smoke_section:
      name: "üí® Configuration Smoke"
      description: Param√®tres pour l'effet de fum√©e grise
      icon: mdi:smoke
      collapsed: true
      input:
        enable_smoke:
          name: "Activer l'effet Smoke"
          description: Active l'effet gris quand le joueur est dans la fum√©e
          default: true
          selector:
            boolean:
        
        smoked_sensor:
          name: "Sensor Smoke"
          description: Sensor indiquant le niveau de smoke (0-100%)
          selector:
            entity:
              domain: sensor
    
    # ===== BURNING =====
    burning_section:
      name: "üî• Configuration Burning"
      description: Param√®tres pour l'effet de flamme
      icon: mdi:fire
      collapsed: true
      input:
        enable_burning:
          name: "Activer l'effet Burning"
          description: Active l'effet de flamme quand le joueur br√ªle
          default: true
          selector:
            boolean:
        
        burning_sensor:
          name: "Sensor Burning"
          description: Sensor indiquant si le joueur br√ªle (0-100%)
          selector:
            entity:
              domain: sensor
    
    # ===== BOMBE =====
    bomb_section:
      name: "üí£ Configuration Bombe"
      description: Param√®tres pour les effets de bombe
      icon: mdi:bomb
      collapsed: true
      input:
        enable_bomb:
          name: "Activer les effets Bombe"
          description: Active les effets de bombe (clignotement rouge/bleu fixe)
          default: true
          selector:
            boolean:
        
        bomb_sensor:
          name: "Sensor Bombe"
          description: Sensor indiquant l'√©tat de la bombe (Inactive/Planted/Exploded/Defused)
          selector:
            entity:
              domain: sensor

mode: restart
max_exceeded: silent

variables:
  light: !input light_entity
  team: !input team_section.current_team
  flashed: !input flash_section.flashed_sensor
  smoked: !input smoke_section.smoked_sensor
  burning: !input burning_section.burning_sensor
  bomb: !input bomb_section.bomb_sensor
  round_phase_sensor: !input team_section.round_phase
  t_color: !input team_section.color_t
  ct_color: !input team_section.color_ct
  enable_team: !input team_section.enable_team_color
  enable_flash_effect: !input flash_section.enable_flash
  enable_smoke_effect: !input smoke_section.enable_smoke
  enable_burning_effect: !input burning_section.enable_burning
  enable_bomb_effect: !input bomb_section.enable_bomb

trigger:
  - platform: state
    entity_id: !input team_section.current_team
  - platform: state
    entity_id: !input flash_section.flashed_sensor
  - platform: state
    entity_id: !input smoke_section.smoked_sensor
  - platform: state
    entity_id: !input burning_section.burning_sensor
  - platform: state
    entity_id: !input bomb_section.bomb_sensor
  - platform: state
    entity_id: !input team_section.round_phase

action:
  - choose:
      # PRIORIT√â 1 : Flash (blanc)
      - conditions:
          - condition: template
            value_template: "{{ enable_flash_effect }}"
          - condition: template
            value_template: >
              {% set flash_state = states(flashed) | string | lower %}
              {{ flash_state == 'true' }}
        sequence:
          - service: light.turn_on
            target:
              entity_id: !input light_entity
            data:
              brightness_pct: 100
              rgb_color: [255, 255, 255]
              transition: 0
      
      # PRIORIT√â 2 : Bombe plant√©e (clignotement rouge selon timer)
      - conditions:
          - condition: template
            value_template: "{{ enable_bomb_effect }}"
          - condition: state
            entity_id: !input bomb_section.bomb_sensor
            state: "Planted"
        sequence:
          - repeat:
              while:
                - condition: state
                  entity_id: !input bomb_section.bomb_sensor
                  state: "Planted"
              sequence:
                - service: light.turn_on
                  target:
                    entity_id: !input light_entity
                  data:
                    brightness_pct: 100
                    rgb_color: [255, 0, 0]
                    transition: 0
                - delay:
                    milliseconds: 500
                - service: light.turn_off
                  target:
                    entity_id: !input light_entity
                  data:
                    transition: 0
                - delay:
                    milliseconds: 500
      
      # PRIORIT√â 3 : Bombe diffus√©e (bleu fixe)
      - conditions:
          - condition: template
            value_template: "{{ enable_bomb_effect }}"
          - condition: state
            entity_id: !input bomb_section.bomb_sensor
            state: "Defused"
        sequence:
          - service: light.turn_on
            target:
              entity_id: !input light_entity
            data:
              brightness_pct: 100
              rgb_color: [0, 150, 255]
              transition: 1
      
      # PRIORIT√â 4 : Burning (effet flamme)
      - conditions:
          - condition: template
            value_template: "{{ enable_burning_effect }}"
          - condition: template
            value_template: >
              {{ states(burning) | int(0) > 0 }}
        sequence:
          - repeat:
              while:
                - condition: template
                  value_template: >
                    {{ states(burning) | int(0) > 0 }}
              sequence:
                # Flamme intense
                - service: light.turn_on
                  target:
                    entity_id: !input light_entity
                  data:
                    brightness_pct: >
                      {{ states(burning) | int(0) }}
                    rgb_color: [255, 50, 0]
                    transition: 0
                - delay:
                    milliseconds: 100
                # Flamme moyenne
                - service: light.turn_on
                  target:
                    entity_id: !input light_entity
                  data:
                    brightness_pct: >
                      {{ (states(burning) | int(0) * 0.7) | int }}
                    rgb_color: [255, 100, 0]
                    transition: 0
                - delay:
                    milliseconds: 100
                # Flamme basse
                - service: light.turn_on
                  target:
                    entity_id: !input light_entity
                  data:
                    brightness_pct: >
                      {{ (states(burning) | int(0) * 0.5) | int }}
                    rgb_color: [255, 150, 0]
                    transition: 0
                - delay:
                    milliseconds: 100
      
      # PRIORIT√â 5 : Smoke (gris)
      - conditions:
          - condition: template
            value_template: "{{ enable_smoke_effect }}"
          - condition: template
            value_template: >
              {{ states(smoked) | int(0) > 0 }}
        sequence:
          - service: light.turn_on
            target:
              entity_id: !input light_entity
            data:
              brightness_pct: >
                {{ states(smoked) | int(0) }}
              rgb_color: [128, 128, 128]
              transition: 0.5
      
      # PRIORIT√â 6 : Couleur d'√©quipe par d√©faut
      - conditions:
          - condition: template
            value_template: "{{ enable_team }}"
          - condition: template
            value_template: >
              {{ states(round_phase_sensor) in ['Live', 'Freezetime'] }}
        sequence:
          - choose:
              # √âquipe T
              - conditions:
                  - condition: state
                    entity_id: !input team_section.current_team
                    state: "T"
                sequence:
                  - service: light.turn_on
                    target:
                      entity_id: !input light_entity
                    data:
                      brightness_pct: 25
                      rgb_color: !input team_section.color_t
                      transition: 1
              
              # √âquipe CT
              - conditions:
                  - condition: state
                    entity_id: !input team_section.current_team
                    state: "CT"
                sequence:
                  - service: light.turn_on
                    target:
                      entity_id: !input light_entity
                    data:
                      brightness_pct: 25
                      rgb_color: !input team_section.color_ct
                      transition: 1
    
    # Par d√©faut : √©teindre la lampe si round termin√©
    default:
      - service: light.turn_off
        target:
          entity_id: !input light_entity
        data:
          transition: 2

blueprint:
  name: CS2 Reactive Lights
  description: >
    ContrÃ´le des lumiÃ¨res en fonction des Ã©vÃ©nements CS2 (Counter-Strike 2) via CS2MQTT.
    RÃ©agit aux flashbangs, HP bas et bombe plantÃ©e.
  domain: automation

  input:
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Lampes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    target_lights:
      name: Lampe(s)
      description: SÃ©lectionnez une ou plusieurs lampes Ã  contrÃ´ler
      selector:
        entity:
          multiple: true
          domain: light

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Flashbang â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    enable_flashbang:
      name: "ğŸ‡ Activer Flashbang"
      description: Active la rÃ©action aux flashbangs
      default: true
      selector:
        boolean: {}

    flashbang_sensor:
      name: Capteur Flashbang
      description: EntitÃ© sensor qui dÃ©tecte les flashbangs
      default: ""
      selector:
        entity:
          domain: sensor

    flashbang_color:
      name: Couleur Flashbang
      description: Couleur lors d'un flashbang (blanc recommandÃ©)
      default: [255, 255, 255]
      selector:
        color_rgb: {}

    flashbang_brightness:
      name: LuminositÃ© Flashbang
      description: LuminositÃ© lors d'un flashbang (0-255)
      default: 255
      selector:
        number:
          min: 0
          max: 255
          mode: slider

    flashbang_duration:
      name: DurÃ©e Flashbang (secondes)
      description: DurÃ©e de l'effet flashbang
      default: 2
      selector:
        number:
          min: 0.5
          max: 10
          step: 0.5
          mode: slider

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Low HP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    enable_low_hp:
      name: "â¤ï¸ Activer Low HP"
      description: Active la rÃ©action aux HP bas
      default: true
      selector:
        boolean: {}

    low_hp_sensor:
      name: Capteur HP
      description: EntitÃ© sensor qui contient la valeur des HP
      default: ""
      selector:
        entity:
          domain: sensor

    low_hp_threshold:
      name: Seuil HP
      description: Seuil en dessous duquel l'effet s'active
      default: 30
      selector:
        number:
          min: 1
          max: 100
          mode: slider

    low_hp_color:
      name: Couleur Low HP
      description: Couleur lors de HP bas (rouge recommandÃ©)
      default: [255, 0, 0]
      selector:
        color_rgb: {}

    low_hp_brightness:
      name: LuminositÃ© Low HP
      description: LuminositÃ© lors de HP bas (0-255)
      default: 200
      selector:
        number:
          min: 0
          max: 255
          mode: slider

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Bombe â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    enable_bomb:
      name: "ğŸ’£ Activer Bombe plantÃ©e"
      description: Active la rÃ©action Ã  la bombe plantÃ©e
      default: true
      selector:
        boolean: {}

    bomb_sensor:
      name: Capteur Bombe
      description: EntitÃ© sensor qui dÃ©tecte la bombe plantÃ©e
      default: ""
      selector:
        entity:
          domain: sensor

    bomb_color:
      name: Couleur Bombe
      description: Couleur lors de bombe plantÃ©e (orange/rouge recommandÃ©)
      default: [255, 100, 0]
      selector:
        color_rgb: {}

    bomb_brightness:
      name: LuminositÃ© Bombe
      description: LuminositÃ© lors de bombe plantÃ©e (0-255)
      default: 255
      selector:
        number:
          min: 0
          max: 255
          mode: slider

    bomb_effect:
      name: Effet Bombe
      description: Type d'effet pour la bombe
      default: "pulse"
      selector:
        select:
          options:
            - label: "Pulsation"
              value: "pulse"
            - label: "Clignotement"
              value: "blink"
            - label: "Fixe"
              value: "static"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# TRIGGERS - DÃ©tection des Ã©vÃ©nements
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
trigger:
  # Flashbang
  - platform: state
    entity_id: !input flashbang_sensor
    to: "on"
    id: flashbang_trigger
    enabled: !input enable_flashbang

  # Low HP
  - platform: numeric_state
    entity_id: !input low_hp_sensor
    below: !input low_hp_threshold
    id: low_hp_trigger
    enabled: !input enable_low_hp

  # Bombe plantÃ©e
  - platform: state
    entity_id: !input bomb_sensor
    to: "planted"
    id: bomb_trigger
    enabled: !input enable_bomb

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# CONDITIONS - Validation
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
condition: []

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ACTIONS - Effets lumineux
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
action:
  - choose:
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€ FLASHBANG â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - conditions:
          - condition: trigger
            id: flashbang_trigger
        sequence:
          - service: light.turn_on
            target:
              entity_id: !input target_lights
            data:
              rgb_color: !input flashbang_color
              brightness: !input flashbang_brightness
              transition: 0
          - delay:
              seconds: !input flashbang_duration
          - service: light.turn_off
            target:
              entity_id: !input target_lights
            data:
              transition: 1

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€ LOW HP â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - conditions:
          - condition: trigger
            id: low_hp_trigger
        sequence:
          - service: light.turn_on
            target:
              entity_id: !input target_lights
            data:
              rgb_color: !input low_hp_color
              brightness: !input low_hp_brightness
              effect: "pulse"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€ BOMBE PLANTÃ‰E â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - conditions:
          - condition: trigger
            id: bomb_trigger
        sequence:
          # DÃ©claration des variables
          - variables:
              bomb_effect: !input bomb_effect
              bomb_brightness: !input bomb_brightness
              bomb_color: !input bomb_color
              bomb_sensor: !input bomb_sensor
          
          - choose:
              # Effet pulsation
              - conditions:
                  - condition: template
                    value_template: "{{ bomb_effect == 'pulse' }}"
                sequence:
                  - repeat:
                      while:
                        - condition: state
                          entity_id: !input bomb_sensor
                          state: "planted"
                      sequence:
                        - service: light.turn_on
                          target:
                            entity_id: !input target_lights
                          data:
                            rgb_color: "{{ bomb_color }}"
                            brightness: "{{ bomb_brightness }}"
                            transition: 1
                        - delay:
                            milliseconds: 500
                        - service: light.turn_on
                          target:
                            entity_id: !input target_lights
                          data:
                            rgb_color: "{{ bomb_color }}"
                            brightness: "{{ (bomb_brightness | int / 2) | int }}"
                            transition: 1
                        - delay:
                            milliseconds: 500

              # Effet clignotement
              - conditions:
                  - condition: template
                    value_template: "{{ bomb_effect == 'blink' }}"
                sequence:
                  - repeat:
                      while:
                        - condition: state
                          entity_id: !input bomb_sensor
                          state: "planted"
                      sequence:
                        - service: light.turn_on
                          target:
                            entity_id: !input target_lights
                          data:
                            rgb_color: "{{ bomb_color }}"
                            brightness: "{{ bomb_brightness }}"
                        - delay:
                            milliseconds: 200
                        - service: light.turn_off
                          target:
                            entity_id: !input target_lights
                        - delay:
                            milliseconds: 200

            # Effet fixe par dÃ©faut
            default:
              - service: light.turn_on
                target:
                  entity_id: !input target_lights
                data:
                  rgb_color: "{{ bomb_color }}"
                  brightness: "{{ bomb_brightness }}"

mode: restart
max_exceeded: silent
